---
title: "Implementation Roadmap"
description: "Gap analysis and implementation plan for ClarkOS"
---

## Current State Assessment

This document outlines the implementation status of ClarkOS features across the demonstration (CLARK) and public SDK (/ink).

## CLARK Demonstration Status

### Implemented

| Feature | Status | Location |
|---------|--------|----------|
| **Memory System** | 95% | `backend/convex/memory/` |
| 5 memory types | Complete | `memory/types.ts` |
| Type-specific deduplication | Complete | `memory/embeddings.ts` |
| Bidirectional linking | Complete | `memory/linking.ts` |
| Memory consolidation | Complete | `memory/consolidation.ts` |
| Self-reflection generation | Complete | `memory/reflection.ts` |
| **Consciousness Layer** | 90% | `backend/convex/consciousness.ts` |
| Input filtering | Complete | Polymarket noise filtering |
| Thought synthesis | Complete | Multi-signal coherence |
| Pattern detection | Complete | Brilliance moments |
| Emotional tone | Complete | Tone assignment |
| **State Model** | 100% | `backend/convex/state.ts` |
| Mood/health/routine | Complete | Full state tracking |
| Routine awareness | Complete | PST time-based |
| State drift | Complete | `backend/convex/tick.ts` |
| **Artifacts** | | |
| Text (thoughts) | Complete | Stored as memories |
| Daily journals | Complete | `backend/convex/dailyJournal.ts` |
| Procedural paintings | Partial | `backend/convex/paintings.ts` |

### Not Implemented

| Feature | Status | Notes |
|---------|--------|-------|
| **Presence Layer** | 0% | |
| Livestream | Not started | No streaming infrastructure |
| Social posting | Not started | COMPOSE_TWEET defined but not executed |
| Web updates | Not started | No publishing endpoints |
| **AI Image Generation** | 0% | Paintings are procedural, not AI-generated |

### API Gaps

Endpoints exist in backend but not exposed via HTTP router:

| Endpoint | Backend File | HTTP Status |
|----------|--------------|-------------|
| `/memories/*` | `memories.ts` | Not wired |
| `/consciousness/*` | `consciousness.ts` | Not wired |
| `/journals/*` | `dailyJournal.ts` | Partial |

---

## /ink SDK Status

### Implemented

| Component | Status | Notes |
|-----------|--------|-------|
| Agent runtime | Complete | `src/core/agent.ts` - Agent class with tick/start/stop |
| Tick execution | Complete | `src/core/tick.ts` - calculateRoutine, calculateHealthDrift |
| Plugin system | Complete | Dependency resolution, lifecycle hooks, actions |
| Configuration | Complete | Zod-validated, env loading (`src/core/config.ts`) |
| Memory store | Complete | get/store/search/update/delete/getStats |
| Memory deduplication | Complete | Type-specific thresholds, 3-tier strategy |
| Knowledge store | Complete | add/get/search/getById/getStats |
| Backend abstraction | Complete | Convex + in-memory backends |
| LLM integration | Complete | OpenRouter, OpenAI, Anthropic, custom |
| Embedding generation | Complete | Gemini and OpenAI support |
| Convex schema | Complete | Full schema with vector indexes |
| Terminal UI | Complete | React Ink components |
| Character system | Complete | Loader, traits, routines |
| Action system | Complete | Registry with builtin actions |
| Template engine | Complete | Tick, reflection, consciousness templates |
| Service layer | Complete | News, Market services |
| **Test Framework** | Complete | Jest with 179 tests |

### Test Coverage

The ink SDK includes a comprehensive Jest test framework:

| Module | Tests | Status |
|--------|-------|--------|
| `core/tick` | 25 | Routine calculation, health drift, tick execution |
| `core/config` | 22 | Configuration validation, env loading, Zod schemas |
| `memory/deduplication` | 34 | 3-tier dedup, type thresholds, similarity |
| `backend/memory` | 22 | In-memory backend, state management, CRUD |
| `plugins/loader` | 26 | Validation, dependency sorting, cycle detection |
| `llm/embeddings` | 32 | Cosine similarity, find similar, providers |
| `services/news` | 21 | Service lifecycle, caching, deduplication |
| **Total** | **179** | All passing |

```bash
# Run tests
npm test

# Watch mode
npm run test:watch

# Coverage report
npm run test:coverage
```

### Not Implemented

| Feature | Priority | Dependency |
|---------|----------|------------|
| Memory linking | Medium | Schema exists, API not exposed |
| Memory consolidation | Medium | Backend exists in CLARK |
| Self-reflection | Medium | Template exists, API not exposed |
| Consciousness layer | Medium | Port from CLARK backend |

---

## Implementation Plan

### Phase 1: CLARK Frontend Delivery

Complete the demonstration to match documented capabilities.

#### 1.1 Wire HTTP Endpoints

Expose existing backend functions via HTTP router.

```typescript
// backend/convex/http.ts additions

// Memory endpoints
router.route({
  path: "/memories",
  method: "GET",
  handler: memories.list
});

router.route({
  path: "/memories/store",
  method: "POST",
  handler: memories.store
});

router.route({
  path: "/memories/context",
  method: "GET",
  handler: memories.getContext
});

// Consciousness endpoints
router.route({
  path: "/consciousness/thoughts",
  method: "GET",
  handler: consciousness.getRecentThoughts
});

router.route({
  path: "/consciousness/process",
  method: "POST",
  handler: consciousness.processConsciousness
});
```

#### 1.2 Presence Layer (Optional)

If social posting is required:

```typescript
// backend/convex/social.ts

export const postTweet = action({
  args: { content: v.string() },
  handler: async (ctx, args) => {
    // Twitter API v2 integration
    const client = new TwitterApi({
      appKey: process.env.TWITTER_API_KEY,
      appSecret: process.env.TWITTER_API_SECRET,
      accessToken: process.env.TWITTER_ACCESS_TOKEN,
      accessSecret: process.env.TWITTER_ACCESS_SECRET,
    });

    return await client.v2.tweet(args.content);
  }
});
```

#### 1.3 Livestream (Optional)

If livestream is required:

- OBS WebSocket integration for scene control
- Text-to-speech service (ElevenLabs, Google TTS)
- State subscription for real-time updates

---

### Phase 2: /ink SDK MVP

Port core features from CLARK to create a functional public SDK.

#### 2.1 Convex Schema

Add schema definitions to /ink for Convex deployment.

```typescript
// ink/convex/schema.ts

import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  state: defineTable({
    mood: v.string(),
    health: v.number(),
    routine: v.string(),
    volatility: v.number(),
    counters: v.object({
      ticks: v.number(),
      feeds: v.number(),
    }),
    lastTick: v.union(v.string(), v.null()),
    cryo: v.boolean(),
  }),

  memories: defineTable({
    type: v.string(),
    content: v.string(),
    scope: v.string(),
    importance: v.number(),
    salience: v.number(),
    valence: v.number(),
    confidence: v.number(),
    unique: v.boolean(),
    tags: v.array(v.string()),
    sourceType: v.string(),
    embedding: v.optional(v.array(v.float64())),
    metadata: v.optional(v.any()),
  })
    .index("by_type", ["type"])
    .index("by_scope", ["scope"])
    .vectorIndex("by_embedding", {
      vectorField: "embedding",
      dimensions: 768,
    }),

  knowledge: defineTable({
    source: v.string(),
    type: v.string(),
    textExcerpt: v.string(),
    url: v.optional(v.string()),
  }),

  logs: defineTable({
    summary: v.string(),
    detail: v.optional(v.string()),
    mood: v.string(),
    health: v.number(),
    routine: v.string(),
  }),
});
```

#### 2.2 Embedding Generation

Add embedding support to memory store.

```typescript
// ink/src/memory/embeddings.ts

export async function generateEmbedding(
  text: string,
  apiKey: string
): Promise<number[]> {
  const response = await fetch(
    "https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent",
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-goog-api-key": apiKey,
      },
      body: JSON.stringify({
        model: "models/text-embedding-004",
        content: { parts: [{ text }] },
      }),
    }
  );

  const data = await response.json();
  return data.embedding.values;
}

export function cosineSimilarity(a: number[], b: number[]): number {
  let dot = 0, normA = 0, normB = 0;
  for (let i = 0; i < a.length; i++) {
    dot += a[i] * b[i];
    normA += a[i] * a[i];
    normB += b[i] * b[i];
  }
  return dot / (Math.sqrt(normA) * Math.sqrt(normB));
}
```

#### 2.3 Memory Deduplication

Port type-specific thresholds from CLARK.

```typescript
// ink/src/memory/deduplication.ts

const DEDUP_THRESHOLDS: Record<MemoryType, number> = {
  episodic: 0.92,
  semantic: 0.95,
  emotional: 0.88,
  procedural: 0.97,
  reflection: 0.90,
};

export async function checkDuplicate(
  newMemory: NewMemory,
  existingMemories: Memory[],
  embedding: number[]
): Promise<{ isDuplicate: boolean; existingId?: string }> {
  const threshold = DEDUP_THRESHOLDS[newMemory.type];

  for (const existing of existingMemories) {
    if (!existing.embedding) continue;

    const similarity = cosineSimilarity(embedding, existing.embedding);
    if (similarity >= threshold) {
      return { isDuplicate: true, existingId: existing.id };
    }
  }

  return { isDuplicate: false };
}
```

#### 2.4 LLM Integration

Add model calling for tick processing.

```typescript
// ink/src/llm/client.ts

export interface LLMConfig {
  provider: "openrouter" | "openai" | "anthropic";
  model: string;
  apiKey: string;
}

export async function complete(
  config: LLMConfig,
  messages: Message[]
): Promise<string> {
  const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${config.apiKey}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      model: config.model,
      messages,
    }),
  });

  const data = await response.json();
  return data.choices[0].message.content;
}
```

#### 2.5 Memory Consolidation

Port consolidation logic.

```typescript
// ink/src/memory/consolidation.ts

export async function consolidateMemories(
  memories: Memory[],
  config: ConsolidationConfig
): Promise<ConsolidationResult> {
  // 1. Apply decay to old memories
  const decayed = applyDecay(memories, config.decayRate);

  // 2. Cluster similar memories
  const clusters = clusterByEmbedding(decayed, config.similarityThreshold);

  // 3. Create core memories from clusters
  const coreMemories = clusters
    .filter(c => c.length >= config.minClusterSize)
    .map(cluster => ({
      content: synthesizeCluster(cluster),
      embedding: averageEmbeddings(cluster.map(m => m.embedding)),
      sourceMemoryIds: cluster.map(m => m.id),
      importance: averageImportance(cluster),
    }));

  return { decayed, coreMemories };
}
```

---

### Phase 3: Advanced Features

After MVP, add differentiating features.

#### 3.1 Self-Reflection

```typescript
// ink/src/memory/reflection.ts

export async function generateReflection(
  memories: Memory[],
  state: AgentState,
  llm: LLMConfig
): Promise<ReflectionMemory> {
  const recentEmotional = memories
    .filter(m => m.type === "emotional")
    .slice(0, 20);

  const prompt = buildReflectionPrompt(recentEmotional, state);
  const insight = await complete(llm, [{ role: "user", content: prompt }]);

  return {
    type: "reflection",
    content: insight,
    scope: "long_term",
    importance: 0.8,
    tags: ["self-reflection", "metacognitive"],
  };
}
```

#### 3.2 Memory Linking

```typescript
// ink/src/memory/linking.ts

export const LINK_TYPES = [
  "caused_by",
  "related_to",
  "contradicts",
  "elaborates",
  "supersedes",
  "temporal_before",
  "temporal_after",
] as const;

export async function detectLinks(
  memory: Memory,
  candidates: Memory[]
): Promise<MemoryLink[]> {
  const links: MemoryLink[] = [];

  for (const candidate of candidates) {
    // Semantic similarity
    const similarity = cosineSimilarity(memory.embedding, candidate.embedding);
    if (similarity > 0.7) {
      links.push({
        sourceId: memory.id,
        targetId: candidate.id,
        type: "related_to",
        strength: similarity,
      });
    }

    // Contradiction detection
    if (memory.valence * candidate.valence < -0.5) {
      links.push({
        sourceId: memory.id,
        targetId: candidate.id,
        type: "contradicts",
        strength: Math.abs(memory.valence - candidate.valence) / 2,
      });
    }
  }

  return links;
}
```

#### 3.3 Consciousness Layer

```typescript
// ink/src/consciousness/index.ts

export function processInputs(
  inputs: ThoughtSeed[],
  state: AgentState
): SynthesizedThought | null {
  // Filter low-value inputs
  const filtered = inputs.filter(i => !isLowValue(i));
  if (filtered.length === 0) return null;

  // Detect patterns
  const entities = extractEntities(filtered);
  const patterns = findPatterns(entities);

  // Determine if brilliant
  const isBrilliant =
    filtered.filter(i => i.importance > 0.7).length >= 2 &&
    patterns.length > 0;

  // Synthesize thought
  return {
    content: synthesize(filtered, patterns),
    tone: determineTone(filtered, state.mood),
    confidence: averageConfidence(filtered),
    isBrilliant,
    triggers: filtered.map(i => i.id),
  };
}
```

---

## Priority Matrix

| Feature | User Value | Complexity | Priority |
|---------|------------|------------|----------|
| Convex schema | Required | Low | P0 |
| LLM integration | Required | Medium | P0 |
| Embedding generation | High | Low | P0 |
| Memory deduplication | High | Medium | P1 |
| HTTP endpoint wiring | High | Low | P1 |
| Memory consolidation | Medium | High | P2 |
| Self-reflection | Medium | Medium | P2 |
| Memory linking | Medium | High | P2 |
| Consciousness layer | Medium | Medium | P2 |
| Social posting | Low | Medium | P3 |
| Livestream | Low | High | P3 |

---

## Delivery Timeline

**Week 1: Foundation**
- Convex schema in /ink
- LLM client implementation
- Embedding generation

**Week 2: Memory**
- Deduplication with thresholds
- Wire HTTP endpoints in CLARK
- Basic consolidation

**Week 3: Intelligence**
- Port consciousness layer
- Self-reflection generation
- Memory linking

**Week 4: Polish**
- Documentation alignment
- Example plugins
- Testing utilities
